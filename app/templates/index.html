<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auto Data Unifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-box { border: 2px dashed #0d6efd; padding: 40px; border-radius: 10px; background: #f8f9fa; }
        .upload-box:hover { background: #e9ecef; }
        .option-card { border: 1px solid #dee2e6; padding: 20px; margin: 10px 0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .option-card:hover { background: #f8f9fa; border-color: #0d6efd; box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15); }
        .option-card input[type="radio"]:checked ~ .option-content { color: #0d6efd; font-weight: bold; }
        .target-schema-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6; }
        .collapsible-header { cursor: pointer; user-select: none; padding: 10px; background: #e9ecef; border-radius: 5px; margin-bottom: 15px; }
        .collapsible-header:hover { background: #dee2e6; }
        .collapsible-content { display: none; }
        .collapsible-content.active { display: block; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5" style="max-width: 800px;">
    <div class="text-center mb-5">
        <h1 class="display-5">‚ö° Auto Data Unifier</h1>
        <p class="lead text-muted">Upload scattered Excel files. Get one Master File back.</p>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form action="/process" method="post" enctype="multipart/form-data">
                <div class="upload-box text-center">
                    <p class="mb-3">Select all your source files (Excel/CSV)</p>
                    <input type="file" class="form-control mb-3" name="files" multiple required id="fileInput">
                </div>
                
                <!-- Target Schema Section (Advanced Options) -->
                <div class="target-schema-section mt-4">
                    <div class="collapsible-header" onclick="toggleTargetSchema()">
                        <strong>üéØ Advanced: Define Target Schema (Optional)</strong>
                        <span class="float-end" id="toggleIcon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="targetSchemaContent">
                        <p class="text-muted small mb-3">
                            By default, the system automatically designs the output schema. 
                            Use this option to specify YOUR desired output format.
                        </p>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Option 1: Upload Template File</strong></label>
                            <p class="text-muted small">Upload a file (CSV/Excel) with column headers that define your desired output structure.</p>
                            <input type="file" class="form-control" name="target_schema_file" accept=".csv,.xlsx,.xls">
                        </div>
                        
                        <div class="text-center my-3">
                            <span class="badge bg-secondary">OR</span>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Option 2: Describe Target Schema</strong></label>
                            <p class="text-muted small">Describe the columns you need (e.g., "I want: customer_id, total_sales, average_order_value")</p>
                            <textarea class="form-control" name="target_schema_text" rows="3" 
                                      placeholder="Example: I need columns: customer_id, customer_name, total_revenue, order_count, average_order_value"></textarea>
                        </div>
                        
                        <div class="alert alert-info small mb-0">
                            <strong>‚ÑπÔ∏è How it works:</strong>
                            <ul class="mb-0 mt-2">
                                <li>System attempts to map your source data to the target schema</li>
                                <li>If mapping fails after 3 attempts, automatically falls back to auto-generated schema</li>
                                <li>You'll be notified which mode was used in the results</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary btn-lg w-100" type="submit">
                        ‚ú® Unify Files Now
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} text-center">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if show_one_to_many_modal and one_to_many_detected %}
    <!-- One-to-Many Resolution Modal -->
    <div class="modal d-block" id="oneToManyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">‚ö†Ô∏è Complex Data Detected: One-to-Many Relationships</h5>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Your data contains different granularities:</p>
                    <ul>
                        <li><strong>Master/Reference data:</strong> One record per entity (e.g., Customer, Property)</li>
                        <li><strong>Detail/Transaction data:</strong> Multiple records per entity (e.g., Orders, History)</li>
                    </ul>
                    <p class="mt-4 mb-3"><strong>How would you like to proceed?</strong></p>

                    <form action="/process" method="post" enctype="multipart/form-data" id="oneToManyForm">
                        <!-- Pass session ID to retrieve stored files -->
                        <input type="hidden" name="session_id" value="{{ session_id }}">
                        
                        <!-- Auto-Solve Option -->
                        <label class="option-card">
                            <input type="radio" name="one_to_many_choice" value="auto_solve" checked>
                            <div class="option-content">
                                <strong>ü§ñ Auto-Solve (Recommended)</strong>
                                <p class="text-muted small mt-2">Let our AI choose the best aggregation strategy for your data</p>
                            </div>
                        </label>

                        <!-- Aggregate Max -->
                        <label class="option-card">
                            <input type="radio" name="one_to_many_choice" value="aggregate_max">
                            <div class="option-content">
                                <strong>üìä Aggregate - Keep Maximum Values</strong>
                                <p class="text-muted small mt-2">For each master record, keep the MAX value from detail records (good for metrics, prices)</p>
                            </div>
                        </label>

                        <!-- Aggregate Min -->
                        <label class="option-card">
                            <input type="radio" name="one_to_many_choice" value="aggregate_min">
                            <div class="option-content">
                                <strong>üìâ Aggregate - Keep Minimum Values</strong>
                                <p class="text-muted small mt-2">For each master record, keep the MIN value from detail records</p>
                            </div>
                        </label>

                        <!-- Aggregate Sum -->
                        <label class="option-card">
                            <input type="radio" name="one_to_many_choice" value="aggregate_sum">
                            <div class="option-content">
                                <strong>‚ûï Aggregate - Sum Values</strong>
                                <p class="text-muted small mt-2">For each master record, SUM all values from detail records (good for totals, amounts)</p>
                            </div>
                        </label>

                        <!-- Aggregate Average -->
                        <label class="option-card">
                            <input type="radio" name="one_to_many_choice" value="aggregate_avg">
                            <div class="option-content">
                                <strong>üìè Aggregate - Average Values</strong>
                                <p class="text-muted small mt-2">For each master record, calculate AVERAGE from detail records</p>
                            </div>
                        </label>

                        <!-- Aggregate Count -->
                        <label class="option-card">
                            <input type="radio" name="one_to_many_choice" value="aggregate_count">
                            <div class="option-content">
                                <strong>üî¢ Aggregate - Count Records</strong>
                                <p class="text-muted small mt-2">For each master record, COUNT how many detail records exist</p>
                            </div>
                        </label>

                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg flex-grow-1">
                                ‚úÖ Continue with Selected Option
                            </button>
                            <a href="/" class="btn btn-secondary btn-lg">
                                ‚Ü©Ô∏è Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
    {% endif %}

    {% if download_file %}
    <div class="card border-success shadow-lg">
        <div class="card-header bg-success text-white text-center">
            <h3>üéâ Processing Complete</h3>
        </div>
        <div class="card-body text-center">
            {% if target_mode_used %}
                {% if target_fallback %}
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Target Schema Fallback</strong><br>
                    Unable to map to your target schema after 3 attempts. Used auto-generated schema instead.
                </div>
                {% else %}
                <div class="alert alert-success">
                    <strong>‚úÖ Target Schema Applied</strong><br>
                    Your data has been unified according to your specified target schema!
                </div>
                {% endif %}
            {% endif %}
            
            <p class="card-text">Your data has been analyzed, matched, and aggregated into a unified master file.</p>
            <p class="text-muted small">Even complex one-to-many data is intelligently merged with smart aggregation:</p>
            <ul class="text-muted small" style="text-align: left; display: inline-block;">
                <li><strong>Numeric fields:</strong> Aggregated (sum/avg/min/max/count)</li>
                <li><strong>Text fields:</strong> Randomly selected from detail records</li>
                <li><strong>Result:</strong> ONE row per master record</li>
            </ul>
            <br><br>
            <a href="{{ url_for('main.download_file', filename=download_file) }}" class="btn btn-success btn-lg">
                üì• Download Unified File
            </a>
            <br><br>
            <a href="/" class="text-muted text-decoration-none">Start Over</a>
        </div>
    </div>
    {% endif %}

</div>

<script>
// Toggle target schema section
function toggleTargetSchema() {
    const content = document.getElementById('targetSchemaContent');
    const icon = document.getElementById('toggleIcon');
    
    if (content.classList.contains('active')) {
        content.classList.remove('active');
        icon.textContent = '‚ñº';
    } else {
        content.classList.add('active');
        icon.textContent = '‚ñ≤';
    }
}

// Restore form data if needed
window.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('oneToManyForm');
    if (form) {
        // Re-submit with the form data
        console.log('One-to-Many modal displayed. User can select resolution option.');
    }
});
</script>

</body>
</html>